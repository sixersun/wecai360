<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>微采360|购物车</title>
  <link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/app.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/global.css">
  <link rel="stylesheet" type="text/css" href="http://libs.useso.com/js/font-awesome/4.2.0/css/font-awesome.min.css">
  <script src='//cdn.bootcss.com/jquery/3.0.0/jquery.min.js'></script>
</head>
<style>
  html,body{background:#f0f0f0}
  .table td{
    line-height:3.5
  }
  .w-footer{

    position: fixed;
    bottom: 0;
    width: 100%;
    background: #fff;
    box-shadow: 1px 1px 1px #ccc;
    border-top: 1px solid #f0f0f0;
    margin-top: 90px;

  }
</style>
<script>
  var data=<?php echo json_encode($list);?>;
  $(function(){
      $('.pronum').blur(function(){
        $('.pm').click();
      });
      $('.pronum').bind('keyup', function(event) {
        if (event.keyCode == "13") {
            $('.pm').click();
        }
      });
      $('.proprice').bind('keyup', function(event) {
        if (event.keyCode == "13") {
            $('.proprice').blur();
        }
      });
      $('.pm').click(function(){
          var proprice=$(this).parents('.pro').find('.proprice').val();
          var action=$(this).attr('data-a');
          var in_nnum=$(this).parents('.input-pm').find('input');
          var in_id=$(this).parents('.input-pm').find('input').attr('data-id');
          var total_price=$(this).parents('.pro').find('.total_price');
          var num=in_nnum.val();
          if(action=='plus'){
             num=parseInt(num)+1;
          }else if(action='minus'){
             if(num==1) return false;
             num=parseInt(num)-1;
          }
          in_nnum.val(num);
          data[in_id-1]['pro_num']=num;
          var total=(Number(num)*Number(proprice)).toFixed(2);
          total_price.html(total);
      });
      $('.proprice').blur(function(){
          var total_price=$(this).parents('.pro').find('.total_price');
          var proprice=$(this).parents('.pro').find('.proprice').val();
          var num=$(this).parents('.pro').find('.pronum').val();
          var total=(Number(num)*Number(proprice)).toFixed(2);
          var p_id=$(this).attr('data-id');
          total_price.html(total);
          data[p_id-1]['price']=proprice;
      });
      $('.export_excel').click(function(){
          //var str = data.toJSONString();
          var str = JSON.stringify(data)
          $('#form_data').val(str);
          $('#excel_form').submit();

      });
      $('.delete').click(function(){
        if(confirm('确认删除？')){
            var shopping_id=$(this).attr('data-shop-id');
            var data_id=$(this).attr('data-id');
            var pro=$(this).parents('.pro');
            console.log(pro);
            $.post('/home/shopping/del_id',{shopping_id:shopping_id},function(ret){
                if(ret.status==1){
                  data_id=data_id-1;
                  delete data[data_id];
                  pro.remove();
                }
            },'json');
        }else{
           return false;
        }
      })
  });
</script>
<body>
    <include file="./include-head" />
    <div ui-view="" class="app-body" id="view" style="margin-top:4rem!important">
    <div class='w-1000 white p-b-md'>
    <div class="box">
      <div class="box-header">
        <h3>购物车</h3>
      </div>
    <div class="table-responsive">
      <table class="table table-striped b-t">
        <thead>
          <tr>
            <th style="width:100px;">
              <label class="ui-check m-a-0">
                <input type="checkbox" class="has-value"><i></i>
                全选
              </label>
            </th>
            <th></th>
            <th>商品名称</th>
            <th>参考单价</th>
            <th>实际单价</th> 
            <th>数量</th>
            <th>小计</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <volist name="list" id='list' > 
            <tr class="pro">
              <td>
                <label class="ui-check m-a-0"><input type="checkbox" name="post[]" class="has-value"><i class="dark-white"></i></label>
              </td>
              <td><img src="{$list.img}" alt="" style="max-height:40px;max-width:40px;overflow:hidden"></td>
              <td>{$list.proname}</td>
              <td>{$list.price}</td>
              <td style="padding-top:18px">
                  <input type="text" class="form-control proprice" data-id='{$i}' style="width:100px;" value="{$list.price}">
              </td>
              <td style="padding-top:18px"> 
                <div class="input-group input-pm" style="width:100px">
                    <span class="input-group-btn">
                        <button class="btn btn-default pm" type="button" data-a='minus'>-</button>
                    </span>
                    <input type="text" class="form-control pronum" placeholder="1" style="width:50px;text-align:center;border-left:none" value="{$list.pro_num}" data-id='{$i}'>
                    <span class="input-group-btn">
                        <button class="btn btn-default pm" type="button" data-a='plus'>+</button>
                    </span>
                </div><!-- /input-group -->
              </td>
              <?php $total_price=number_format($list['pro_num']*$list['price'],2) ?>
              <td class="total_price">{$total_price}</td>
              <td>
                <a href="javascript:;" class="delete" data-id='{$i}' data-shop-id='{$list.id}' ui-toggle-class="">&nbsp;&nbsp;<i class="fa fa-times text-danger inline"></i></a>
              </td>
            </tr>
          </volist>
        </tbody>
      </table>
    </div>
  </div>
  </div>
  </div>
  <div class="white w-footer">
    <div class="footer p-a p-x-md">
      <div class="row">
        <div class="col-sm-3 clearfix">
          <a class="navbar-brand">
            <span class="hidden-folded inline">微采360</span>
          </a>
        </div>
        <div class="col-sm-3 col-md-offset-6">
            <form action="/home/shopping/export_excel" method='POST' id="excel_form">
                <input type="hidden" name='data' id='form_data'>
            </form>
            <button class="btn btn-fw primary m-t export_excel">导出Excel</button>
        </div>
      </div>
    </div>
  </div>
  </body>
</html>